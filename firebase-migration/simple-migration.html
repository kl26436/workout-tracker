<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fixed Exercise & Workout Migration</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #0d1117;
            color: #c9d1d9;
        }
        .container {
            background: #161b22;
            padding: 30px;
            border-radius: 8px;
            border: 1px solid #30363d;
        }
        h1 {
            color: #40e0d0;
            text-align: center;
            margin-bottom: 20px;
        }
        .status {
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            font-weight: bold;
        }
        .status-info { background: #1f6feb; }
        .status-success { background: #238636; }
        .status-warning { background: #d29922; color: #0d1117; }
        .status-error { background: #da3633; }
        .btn {
            background: #40e0d0;
            color: #0d1117;
            border: none;
            padding: 15px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            margin: 10px 10px 10px 0;
            font-size: 16px;
        }
        .btn:hover {
            background: #36c7b8;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-secondary {
            background: #6e7681;
            color: #c9d1d9;
        }
        .btn-secondary:hover {
            background: #8b949e;
        }
        .log {
            background: #21262d;
            padding: 20px;
            border-radius: 6px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #30363d;
            font-size: 14px;
            line-height: 1.4;
        }
        .progress {
            background: #21262d;
            border-radius: 10px;
            height: 20px;
            margin: 20px 0;
            overflow: hidden;
            border: 1px solid #30363d;
        }
        .progress-bar {
            background: linear-gradient(90deg, #40e0d0, #36c7b8);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }
        .section {
            margin: 30px 0;
            padding: 20px;
            background: #0d1117;
            border-radius: 6px;
            border: 1px solid #30363d;
        }
        .section h3 {
            color: #40e0d0;
            margin-top: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Fixed Exercise & Workout Migration</h1>
        <p style="text-align: center; margin-bottom: 30px;">
            This tool will migrate your exercises and workouts to the correct Firebase locations.
        </p>

        <div class="section">
            <h3>üë§ Authentication</h3>
            <div id="userStatus" class="status status-warning">
                Please sign in to continue...
            </div>
            <button id="signInBtn" class="btn" onclick="signIn()">üîê Sign In with Google</button>
            <button id="signOutBtn" class="btn btn-secondary" onclick="signOut()" style="display: none;">üö™ Sign Out</button>
        </div>

        <div class="section">
            <h3>üîç Current State</h3>
            <div id="stateStatus" class="status status-info">
                Click "Test Current State" to check your Firebase data.
            </div>
            <button id="testBtn" class="btn btn-secondary" onclick="testState()" disabled>üîç Test Current State</button>
        </div>

        <div class="section">
            <h3>üì¶ Migration</h3>
            <div id="migrationStatus" class="status status-info">
                Ready to run migration when signed in.
            </div>
            
            <div class="progress">
                <div class="progress-bar" id="progress"></div>
            </div>

            <button id="migrateBtn" class="btn" onclick="runMigration()" disabled>
                üöÄ Run Fixed Migration
            </button>
            
            <button id="statusBtn" class="btn btn-secondary" onclick="checkStatus()" disabled>
                üìä Check Migration Status
            </button>
        </div>

        <div class="section">
            <h3>üìã Log</h3>
            <div id="log" class="log">Waiting for action...</div>
            <button class="btn btn-secondary" onclick="clearLog()">üßπ Clear Log</button>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules directly since we're in firebase-migration/
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import {
            getFirestore, doc, setDoc, getDoc, deleteDoc, collection, query, where, getDocs, orderBy, limit, onSnapshot
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import {
            getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut as firebaseSignOut
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAbzL4bGY026Z-oWiWcYLfDgkmmgAfUY3k",
            authDomain: "workout-tracker-b94b6.firebaseapp.com",
            projectId: "workout-tracker-b94b6",
            storageBucket: "workout-tracker-b94b6.appspot.com",
            messagingSenderId: "111958991290",
            appId: "1:111958991290:web:23e1014ab2ba27df6ebd83"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let migration = null;

        // Create a simple migration class for this standalone page
        class StandaloneMigration {
            constructor() {
                this.db = db;
            }

            async testCurrentState() {
                try {
                    log('üîç Testing current Firebase state...');
                    
                    // Check exercises
                    const exercisesRef = collection(this.db, 'exercises');
                    const exercisesSnapshot = await getDocs(exercisesRef);
                    const exercises = exercisesSnapshot.docs.filter(doc => doc.id !== 'default');
                    
                    log(`üìö Found ${exercises.length} exercises in root collection`);
                    
                    // Check workouts
                    const workoutsRef = collection(this.db, 'workouts');
                    const workoutsSnapshot = await getDocs(workoutsRef);
                    const workouts = workoutsSnapshot.docs.filter(doc => doc.id !== 'default');
                    
                    log(`üí™ Found ${workouts.length} workouts in root collection`);
                    
                    // Check if exercises.json exists
                    try {
                        const response = await fetch('../exercises.json');
                        if (response.ok) {
                            const exercisesJson = await response.json();
                            log(`üìÑ Found exercises.json with ${exercisesJson.length} exercises`);
                        } else {
                            log('‚ùå Could not find exercises.json');
                        }
                    } catch (error) {
                        log('‚ùå Error checking exercises.json: ' + error.message);
                    }
                    
                    return {
                        exerciseCount: exercises.length,
                        workoutCount: workouts.length,
                        needsMigration: exercises.length === 0
                    };
                    
                } catch (error) {
                    log(`‚ùå Error testing current state: ${error.message}`);
                    return { error: error.message };
                }
            }

            async runMigration() {
                try {
                    log('üöÄ Starting Fixed Migration...');
                    updateProgress(10);
                    
                    if (!currentUser) {
                        throw new Error('Please sign in first');
                    }
                    
                    // Load exercises.json
                    log('üì• Loading exercises from exercises.json...');
                    const exerciseResponse = await fetch('../exercises.json');
                    if (!exerciseResponse.ok) {
                        throw new Error('Could not load exercises.json');
                    }
                    const exercises = await exerciseResponse.json();
                    log(`üìö Loaded ${exercises.length} exercises from JSON`);
                    updateProgress(30);
                    
                    // Load workouts.json
                    log('üì• Loading workouts from workouts.json...');
                    const workoutResponse = await fetch('../workouts.json');
                    if (!workoutResponse.ok) {
                        throw new Error('Could not load workouts.json');
                    }
                    const workouts = await workoutResponse.json();
                    log(`üí™ Loaded ${workouts.length} workouts from JSON`);
                    updateProgress(50);
                    
                    // Migrate exercises
                    const exerciseCount = await this.migrateExercises(exercises);
                    updateProgress(75);
                    
                    // Migrate workouts
                    const workoutCount = await this.migrateWorkouts(workouts);
                    updateProgress(100);
                    
                    log('üéâ Migration completed successfully!');
                    log(`üìä Summary: ${exerciseCount} exercises, ${workoutCount} workouts`);
                    
                    return {
                        success: true,
                        exerciseCount,
                        workoutCount
                    };
                    
                } catch (error) {
                    log(`‚ùå Migration failed: ${error.message}`);
                    return { success: false, error: error.message };
                }
            }

            async migrateExercises(exercises) {
                log('üîÑ Migrating exercises to Firebase...');
                
                const { writeBatch } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                const batch = writeBatch(this.db);
                let migratedCount = 0;
                
                for (const exercise of exercises) {
                    const exerciseId = this.generateExerciseId(exercise.name || exercise.machine || 'unknown');
                    const docRef = doc(this.db, 'exercises', exerciseId);
                    
                    const exerciseData = {
                        ...exercise,
                        id: exerciseId,
                        isDefault: true,
                        isCustom: false,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString(),
                        name: exercise.name || exercise.machine || 'Unknown Exercise',
                        bodyPart: exercise.bodyPart || 'other',
                        equipmentType: exercise.equipmentType || 'other',
                        sets: exercise.sets || 3,
                        reps: exercise.reps || 10,
                        weight: exercise.weight || 50,
                        video: exercise.video || ''
                    };
                    
                    batch.set(docRef, exerciseData);
                    migratedCount++;
                    
                    if (migratedCount % 20 === 0) {
                        log(`‚ûï Added ${migratedCount} exercises...`);
                    }
                }
                
                await batch.commit();
                
                // Set metadata
                await setDoc(doc(this.db, 'exercises', 'default'), {
                    lastUpdated: new Date().toISOString(),
                    exerciseCount: migratedCount,
                    migratedFrom: 'exercises.json',
                    migrationVersion: '2.0'
                });
                
                log(`‚úÖ Successfully migrated ${migratedCount} exercises`);
                return migratedCount;
            }

            async migrateWorkouts(workouts) {
                log('üîÑ Migrating workouts to Firebase...');
                
                const { writeBatch } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                const batch = writeBatch(this.db);
                let migratedCount = 0;
                
                for (const workout of workouts) {
                    const workoutId = this.generateWorkoutId(workout.name || workout.day || 'unknown');
                    const docRef = doc(this.db, 'workouts', workoutId);
                    
                    const workoutData = {
                        ...workout,
                        id: workoutId,
                        isDefault: true,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString(),
                        name: workout.name || workout.day || 'Unknown Workout',
                        day: workout.day || workout.name || 'General',
                        category: workout.category || this.getWorkoutCategory(workout.day || workout.name),
                        exercises: workout.exercises || []
                    };
                    
                    batch.set(docRef, workoutData);
                    migratedCount++;
                    
                    if (migratedCount % 10 === 0) {
                        log(`‚ûï Added ${migratedCount} workouts...`);
                    }
                }
                
                await batch.commit();
                
                // Set metadata
                await setDoc(doc(this.db, 'workouts', 'default'), {
                    lastUpdated: new Date().toISOString(),
                    templateCount: migratedCount,
                    migratedFrom: 'workouts.json',
                    migrationVersion: '2.0'
                });
                
                log(`‚úÖ Successfully migrated ${migratedCount} workouts`);
                return migratedCount;
            }

            getWorkoutCategory(day) {
                if (!day) return 'general';
                const dayLower = day.toLowerCase();
                if (dayLower.includes('chest') || dayLower.includes('push')) return 'push';
                if (dayLower.includes('back') || dayLower.includes('pull')) return 'pull';
                if (dayLower.includes('leg') || dayLower.includes('lower')) return 'legs';
                if (dayLower.includes('shoulder') || dayLower.includes('arm')) return 'push';
                if (dayLower.includes('cardio') || dayLower.includes('hiit')) return 'cardio';
                return 'general';
            }

            generateExerciseId(name) {
                if (!name || typeof name !== 'string') {
                    name = 'unknown_exercise_' + Date.now();
                }
                return name.toLowerCase().replace(/[^a-z0-9\s]/g, '').replace(/\s+/g, '_').substring(0, 50);
            }

            generateWorkoutId(name) {
                if (!name || typeof name !== 'string') {
                    name = 'unknown_workout_' + Date.now();
                }
                return name.toLowerCase().replace(/[^a-z0-9\s]/g, '').replace(/\s+/g, '_').substring(0, 50);
            }

            async checkMigrationStatus() {
                try {
                    if (currentUser) {
                        const migrationDoc = await getDoc(doc(this.db, 'users', currentUser.uid, 'migration', 'phase1'));
                        if (migrationDoc.exists()) {
                            const data = migrationDoc.data();
                            return {
                                completed: data.phase1MigrationCompleted || false,
                                date: data.migrationDate,
                                version: data.version || '1.0'
                            };
                        }
                    }
                    
                    // Check if exercises exist
                    const exercisesRef = collection(this.db, 'exercises');
                    const exercisesSnapshot = await getDocs(exercisesRef);
                    const exercises = exercisesSnapshot.docs.filter(doc => doc.id !== 'default');
                    
                    if (exercises.length > 0) {
                        return {
                            completed: true,
                            date: 'Detected from data',
                            exerciseCount: exercises.length
                        };
                    }
                    
                    return { completed: false };
                    
                } catch (error) {
                    log(`‚ùå Error checking status: ${error.message}`);
                    return { completed: false, error: error.message };
                }
            }
        }

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            migration = new StandaloneMigration();
            
            // Set up auth listener
            onAuthStateChanged(auth, (user) => {
                currentUser = user;
                updateUI();
            });
        });

        function updateUI() {
            const userStatus = document.getElementById('userStatus');
            const signInBtn = document.getElementById('signInBtn');
            const signOutBtn = document.getElementById('signOutBtn');
            const testBtn = document.getElementById('testBtn');
            const migrateBtn = document.getElementById('migrateBtn');
            const statusBtn = document.getElementById('statusBtn');
            
            if (currentUser) {
                userStatus.innerHTML = `‚úÖ Signed in as: <strong>${currentUser.email}</strong>`;
                userStatus.className = 'status status-success';
                signInBtn.style.display = 'none';
                signOutBtn.style.display = 'inline-block';
                testBtn.disabled = false;
                migrateBtn.disabled = false;
                statusBtn.disabled = false;
            } else {
                userStatus.innerHTML = '‚ùå Please sign in to continue...';
                userStatus.className = 'status status-warning';
                signInBtn.style.display = 'inline-block';
                signOutBtn.style.display = 'none';
                testBtn.disabled = true;
                migrateBtn.disabled = true;
                statusBtn.disabled = true;
            }
        }

        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        function updateProgress(percent) {
            const progressBar = document.getElementById('progress');
            progressBar.style.width = percent + '%';
        }

        function updateStatus(message, type = 'info') {
            const statusElement = document.getElementById('migrationStatus');
            statusElement.textContent = message;
            statusElement.className = `status status-${type}`;
        }

        function updateStateStatus(message, type = 'info') {
            const statusElement = document.getElementById('stateStatus');
            statusElement.textContent = message;
            statusElement.className = `status status-${type}`;
        }

        // Global functions for buttons
        window.signIn = async function() {
            try {
                log('üîê Signing in...');
                const result = await signInWithPopup(auth, provider);
                log(`‚úÖ Signed in as ${result.user.email}`);
            } catch (error) {
                log(`‚ùå Sign in failed: ${error.message}`);
            }
        };

        window.signOut = async function() {
            try {
                await firebaseSignOut(auth);
                log('üö™ Signed out successfully');
            } catch (error) {
                log(`‚ùå Sign out failed: ${error.message}`);
            }
        };

        window.testState = async function() {
            if (!currentUser || !migration) {
                log('‚ùå Please sign in first');
                return;
            }

            try {
                updateStateStatus('Testing...', 'info');
                const result = await migration.testCurrentState();
                
                if (result.error) {
                    updateStateStatus(`Error: ${result.error}`, 'error');
                } else {
                    const message = `Found ${result.exerciseCount} exercises, ${result.workoutCount} workouts. ${result.needsMigration ? 'Migration needed!' : 'Data exists.'}`;
                    updateStateStatus(message, result.needsMigration ? 'warning' : 'success');
                }
            } catch (error) {
                log(`‚ùå Test failed: ${error.message}`);
                updateStateStatus(`Test failed: ${error.message}`, 'error');
            }
        };

        window.runMigration = async function() {
            if (!currentUser || !migration) {
                log('‚ùå Please sign in first');
                return;
            }

            try {
                updateStatus('Running migration...', 'info');
                updateProgress(0);
                
                const result = await migration.runMigration();
                
                if (result.success) {
                    updateStatus(`‚úÖ Migration successful! ${result.exerciseCount} exercises, ${result.workoutCount} workouts`, 'success');
                    alert(`Migration completed successfully!\n\nMigrated:\n- ${result.exerciseCount} exercises\n- ${result.workoutCount} workouts\n\nYour app should now load default exercises correctly!`);
                } else {
                    updateStatus(`‚ùå Migration failed: ${result.error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Migration failed: ${error.message}`);
                updateStatus(`‚ùå Migration failed: ${error.message}`, 'error');
            }
        };

        window.checkStatus = async function() {
            if (!migration) {
                log('‚ùå Migration not initialized');
                return;
            }

            try {
                const status = await migration.checkMigrationStatus();
                
                if (status.completed) {
                    log(`‚úÖ Migration completed on ${status.date} (version: ${status.version || 'unknown'})`);
                    if (status.exerciseCount) {
                        log(`üìä Found ${status.exerciseCount} exercises in Firebase`);
                    }
                    updateStatus('‚úÖ Migration already completed', 'success');
                } else {
                    log('‚ùå Migration not completed yet');
                    updateStatus('‚ùå Migration not completed', 'warning');
                }
            } catch (error) {
                log(`‚ùå Status check failed: ${error.message}`);
            }
        };

        window.clearLog = function() {
            document.getElementById('log').textContent = 'Log cleared...\n';
            updateProgress(0);
        };

        // Initialize UI
        updateUI();
    </script>
</body>
</html>